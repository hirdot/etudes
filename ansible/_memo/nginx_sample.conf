# Generated by ansible

####### application http setting #######
# メンテナンスモード時の許可ユーザーリストの読み込み
geo $allow_maintenance_user {
  default 0;
  include allow_maintenance.conf;
}

# upstream setting
upstream my_app {
  server xxxx.xxx.xxx.xxxx
}

server {
  listen 80;
  server_name xxxxxxxx
  root {{app_root}}{{current_path}};

# whitelistの読み込み
  include /etc/nginx/client-allow.conf;
  deny all;

# maintenance mode の設定
  error_page 503 @maintenance;
  set $maintenance false;
  if (-f "/tmp/maintenance.txt") {
    set $maintenance true;
  }
  if ($allow_maintenance_user = 1) {
    set $maintenance false;
  }

  location /robots.txt {
    alias {{app_root}}{{current_path}}/robots.txt;
  }
  if ($request_method !~ ^(GET|HEAD|PUT|PATCH|POST|DELETE|OPTIONS)$ ){
    return 405;
  }
  error_page 502 504 /50x.html;
  location = /50x.html {
    root   /usr/share/nginx/html;
  }
  location ~ (\.git|\.svn) {
    deny  all;
  }
  location @maintenance {
    root {{app_root}}{{current_path}};
    rewrite ^(.*)$ /503.html break;
  }

  location / {
    proxy_redirect off;

    if ($maintenance = true) {
      return 503;
    }

    if (!-f $request_filename) {
      proxy_pass http://my_app;
      break;
    }
  }
}

